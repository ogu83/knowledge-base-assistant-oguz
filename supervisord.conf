[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:postgres]
# Run PostgreSQL in foreground
command=/bin/bash -lc "PG_BIN=$(dirname $(realpath /usr/lib/postgresql/*/bin/postgres)); exec $PG_BIN/postgres -D /var/lib/postgresql/data -c listen_addresses='*'"
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/postgres.log
stderr_logfile=/var/log/supervisor/postgres.err

[program:initdb_once]
# Initialize/seed DB after Postgres is up. Runs once.
command=/bin/bash -lc "python /app/backend/init_db.py"
directory=/app/backend
user=appuser
autostart=true
autorestart=false
startretries=3
startsecs=10
priority=20
stdout_logfile=/var/log/supervisor/initdb.log
stderr_logfile=/var/log/supervisor/initdb.err

[program:api]
# Start FastAPI with Uvicorn
command=/bin/bash -lc "uvicorn app:app --host 0.0.0.0 --port 8000"
directory=/app/backend
user=appuser
autostart=true
autorestart=true
startsecs=5
priority=30
stdout_logfile=/var/log/supervisor/api.log
stderr_logfile=/var/log/supervisor/api.err

[program:frontend]
# Serve the static frontend at :8001
command=/bin/bash -lc "python -m http.server 8001"
directory=/app/frontend
user=appuser
autostart=true
autorestart=true
startsecs=3
priority=40
stdout_logfile=/var/log/supervisor/frontend.log
stderr_logfile=/var/log/supervisor/frontend.err
