<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Knowledge Base Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Vue 3 (CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app" class="wrap">
      <div class="panel">
        <h1>Knowledge Base Assistant</h1>

        <!-- Search form -->
        <div class="form">
          <input
            v-model="query"
            @keyup.enter="doSearch"
            type="text"
            placeholder="Search articles (e.g., PostgreSQL indexes, SQL joins)"
          />
          <select v-model="category">
            <option value="">All categories</option>
            <option v-for="c in categories" :key="c" :value="c">{{ c }}</option>
          </select>
          <button @click="doSearch" :disabled="loadingSearch">
            <span v-if="loadingSearch" class="spinner"></span>
            <span v-else>Search</span>
          </button>
        </div>

        <!-- Results grid with selectable cards -->
        <div class="results" v-if="results.length">
          <div class="card" v-for="r in results" :key="r.id">
            <div class="row">
              <div class="left">
                <input type="checkbox" v-model="r.selected" />
                <div class="title">{{ r.title }}</div>
              </div>
              <div class="meta">
                {{ r.author_name }} • {{ r.category_name }} • {{ r.publish_date }}
              </div>
            </div>
            <div class="excerpt">{{ r.excerpt }}...</div>
            <div class="tags">
              <span v-for="t in tagList(r.tags)" :key="t" class="tag">{{ t }}</span>
            </div>
          </div>
        </div>

        <div v-else-if="!loadingSearch && !error && queryTouched" class="empty">
          No results found. Try another query or remove the category filter.
        </div>

        <div v-if="error" class="error">{{ error }}</div>

        <!-- Ask bar (single input + button for all selected results) -->
        <div class="askbar" v-if="results.length">
          <input
            v-model="askText"
            type="text"
            placeholder="Ask the AI about the selected articles…"
          />
          <button
            @click="askSelected"
            :disabled="!hasSelection || loadingAskSelected"
            title="Ask about selected results"
          >
            <span v-if="loadingAskSelected" class="spinner"></span>
            <span v-else>Ask AI</span>
          </button>
          <button
            class="linkish"
            v-if="hasSelection"
            @click="clearSelection"
            :disabled="loadingAskSelected"
            title="Clear selected"
          >
            Clear selection
          </button>
        </div>

        <!-- Chat (separate from results; Q appears directly above A) -->
        <div class="chat" v-if="messages.length">
          <div class="turn" v-for="(m,i) in messages" :key="i">
            <div class="msg user">
              <div class="bubble">
                <div class="muted">You asked</div>
                <div>{{ m.question }}</div>
              </div>
            </div>
            <div class="msg ai">
              <div class="bubble">
                <div class="muted">Assistant</div>
                <div style="white-space: pre-wrap">{{ m.answer }}</div>
                <div class="muted" style="margin-top: 6px; font-size: 12px">
                  Sources: IDs {{ m.used_article_ids.join(', ') }}
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <script>
      const { createApp, reactive, toRefs, computed } = Vue;

      createApp({
        setup() {
          const state = reactive({
            baseUrl: "http://localhost:8000", // adjust if backend runs elsewhere
            query: "",
            category: "",
            categories: ["Python", "Databases", "Frontend", "DevOps", "LLMs"],
            results: [],
            loadingSearch: false,
            queryTouched: false,
            error: "",
            messages: [],
            askText: "",
            loadingAskSelected: false,
          });

          const tagList = (csv) =>
            (csv || "")
              .split(",")
              .map((s) => s.trim())
              .filter(Boolean);

          const hasSelection = computed(() =>
            state.results.some((r) => r.selected)
          );

          function clearSelection() {
            state.results.forEach((r) => (r.selected = false));
          }

          async function doSearch() {
            state.error = "";
            state.queryTouched = true;
            state.loadingSearch = true;
            state.results = [];
            try {
              const params = new URLSearchParams({ query: state.query });
              if (state.category) params.set("category", state.category);

              const res = await fetch(
                `${state.baseUrl}/api/search?` + params.toString()
              );
              if (!res.ok) throw new Error(`Search failed (${res.status})`);
              const json = await res.json();

              // add selection flag per result
              state.results = (json.results || []).map((r) => ({
                ...r,
                selected: false,
              }));
            } catch (e) {
              state.error = e.message || "Search error.";
            } finally {
              state.loadingSearch = false;
            }
          }

          async function askSelected() {
            state.error = "";
            state.loadingAskSelected = true;
            try {
              const context_ids = state.results
                .filter((r) => r.selected)
                .map((r) => r.id);

              if (context_ids.length === 0) {
                throw new Error("Select at least one result first.");
              }

              const question =
                state.askText && state.askText.trim()
                  ? state.askText.trim()
                  : "Summarize the selected articles and key takeaways.";

              const res = await fetch(`${state.baseUrl}/api/ask`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ context_ids, question }),
              });
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || `Ask failed (${res.status})`);
              }
              const json = await res.json();

              state.messages.push({
                question,
                answer: json.answer,
                used_article_ids: json.used_article_ids || [],
              });

              // quality-of-life cleanups
              state.askText = "";
              clearSelection();
            } catch (e) {
              state.error = e.message || "Ask error.";
            } finally {
              state.loadingAskSelected = false;
            }
          }

          return {
            ...toRefs(state),
            doSearch,
            tagList,
            askSelected,
            clearSelection,
            hasSelection,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
